<!-- src/templates/dashboard/insights.html -->
<div class="container mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold mb-6">هوش سئو و تحلیل صفحه</h1>

    <!-- URL Input Form -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <form id="ai-analyzer-form" class="flex flex-col sm:flex-row items-center sm:space-x-4 space-y-4 sm:space-y-0">
            <input type="url" id="page-url" placeholder="آدرس صفحه‌ای که می‌خواهید تحلیل شود..." class="flex-grow w-full px-4 py-2 border rounded-lg" required>
            <button type="submit" id="analyze-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">تحلیل کن</button>
        </form>
    </div>

    <!-- Results Area -->
    <div id="loading-indicator" class="hidden text-center p-6">
        <p>در حال تحلیل صفحه، لطفاً منتظر بمانید...</p>
    </div>
    <div id="error-message" class="hidden text-center p-6 bg-red-100 text-red-700 rounded-lg"></div>

    <div id="results-container" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- SEO Score Chart -->
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md text-center">
                <h2 class="text-lg font-semibold mb-4">امتیاز کلی سئو</h2>
                <div class="relative w-48 h-48 mx-auto">
                    <canvas id="seo-score-chart"></canvas>
                    <div id="score-text" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-bold text-gray-800"></div>
                </div>
            </div>

            <!-- Recommendations List -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold mb-4">پیشنهادهای هوشمند برای بهبود</h2>
                <ul id="recommendations-list" class="space-y-4 text-gray-700">
                    <!-- Recommendations will be populated here -->
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('ai-analyzer-form');
        const urlInput = document.getElementById('page-url');
        const analyzeBtn = document.getElementById('analyze-btn');
        const resultsContainer = document.getElementById('results-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const recommendationsList = document.getElementById('recommendations-list');
        const chartCanvas = document.getElementById('seo-score-chart');
        const scoreText = document.getElementById('score-text');
        let seoChart = null;

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const urlToAnalyze = urlInput.value;

            resultsContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'در حال تحلیل...';

            try {
                // We use the main SEO analysis API
                const response = await fetch(`/api/dashboard/analytics/seo?url=${encodeURIComponent(urlToAnalyze)}`);
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'خطا در ارتباط با سرور.');
                }
                const data = await response.json();
                displayResults(data);
            } catch (err) {
                errorMessage.textContent = err.message;
                errorMessage.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'تحلیل کن';
            }
        });

        function displayResults(data) {
            // Display recommendations
            if (data.recommendations.length > 0) {
                recommendationsList.innerHTML = data.recommendations.map(rec =>
                    `<li class="flex items-start"><span class="text-red-500 mr-2 mt-1">&#10007;</span> <span>${rec}</span></li>`
                ).join('');
            } else {
                 recommendationsList.innerHTML = `<li class="flex items-center text-green-600"><span class="mr-2">&#10003;</span> <span>عالی! هیچ پیشنهاد فوری برای بهبود یافت نشد.</span></li>`;
            }

            // Update score text
            scoreText.textContent = data.score;

            // Update or create the chart
            if (seoChart) seoChart.destroy();
            seoChart = new Chart(chartCanvas, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [data.score, 100 - data.score],
                        backgroundColor: [data.score > 80 ? '#10B981' : data.score > 50 ? '#F59E0B' : '#EF4444', '#E5E7EB'],
                        borderWidth: 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '80%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });

            resultsContainer.classList.remove('hidden');
        }
    });
</script>
